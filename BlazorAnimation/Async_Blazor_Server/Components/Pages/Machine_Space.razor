@page "/machineAnimation"
@rendermode InteractiveServer

<h2 class="text-xl mb-2">Prozess-Simulation</h2>

<div class="sim-area">
    <img class="storage" src="storage.png" />

    <!-- Machine A with vertical movement -->
    <img class="machineA @(machineAWorking ? "working" : "")" 
         style="transform: translateY(@machineAYOffset);" 
         src="drilling.png" />

    <!-- Machine B with vertical movement -->
    <img class="machineB @(machineBWorking ? "working" : "")"
         style="transform: translateY(@machineBYOffset);"
         src="industrial-robot.png" />

    <img class="crane" style="left:@craneXpx" src="construction.png" />
</div>

<button class="mt-3 p-2 bg-blue-600 text-white rounded" @onclick="StartSim">Start Simulation</button>

@code {
    // === Semaphore coordination ===
    static SemaphoreSlim semCrane;
    static SemaphoreSlim semA;
    static SemaphoreSlim semB;
    static SemaphoreSlim semReturn;

    // === Visual State ===
    bool machineAWorking = false;
    bool machineBWorking = false;

    // NEW â€” Y offsets
    string machineAYOffset = "0px";
    string machineBYOffset = "0px";

    string craneXpx = "0px";

    async Task StartSim()
    {
        var crane = new Crane(this);
        var a = new MachineA(this);
        var b = new MachineB(this);
        semCrane = new(1, 1);
        semA = new(0, 1);
        semB = new(0, 1);
        semReturn = new(0, 1);
        _ = Task.Run(() => crane.Run());
        _ = Task.Run(() => a.Run());
        _ = Task.Run(() => b.Run());
    }

    // === MachineA ===
    public class MachineA
    {
        private readonly Machine_Space ui;
        public MachineA(Machine_Space ui) => this.ui = ui;

        public async Task Run()
        {
            while (true)
            {
                await semA.WaitAsync();
                await Process();
                semCrane.Release();
            }
        }

        private async Task Process()
        {
            // --- Move up ---
            ui.machineAYOffset = "-25px";
            await ui.InvokeAsync(ui.StateHasChanged);
            await Task.Delay(300);

            // --- Work ---
            ui.machineAWorking = true;
            await ui.InvokeAsync(ui.StateHasChanged);
            await Task.Delay(1000);
            ui.machineAWorking = false;

            // --- Move down ---
            ui.machineAYOffset = "0px";
            await ui.InvokeAsync(ui.StateHasChanged);
            await Task.Delay(300);

            await ui.InvokeAsync(ui.StateHasChanged);
        }
    }

    // === MachineB ===
    public class MachineB
    {
        private readonly Machine_Space ui;
        public MachineB(Machine_Space ui) => this.ui = ui;

        public async Task Run()
        {
            while (true)
            {
                await semB.WaitAsync();
                await Process();
                semReturn.Release();
            }
        }

        private async Task Process()
        {
            // --- Move up ---
            ui.machineBYOffset = "-25px";
            await ui.InvokeAsync(ui.StateHasChanged);
            await Task.Delay(300);

            // --- Work ---
            ui.machineBWorking = true;
            await ui.InvokeAsync(ui.StateHasChanged);
            await Task.Delay(1500);
            ui.machineBWorking = false;

            // --- Move down ---
            ui.machineBYOffset = "0px";
            await ui.InvokeAsync(ui.StateHasChanged);
            await Task.Delay(300);

            await ui.InvokeAsync(ui.StateHasChanged);
        }
    }

    // === Crane ===
    public class Crane
    {
        private readonly Machine_Space ui;
        public Crane(Machine_Space ui) => this.ui = ui;

        public async Task Run()
        {
            await semCrane.WaitAsync();
            await Move("Storage", "MachineA", "180px");
            semA.Release();

            await semCrane.WaitAsync();
            await Move("MachineA", "MachineB", "325px");
            semB.Release();

            await semReturn.WaitAsync();
            await Move("MachineB", "Storage", "0px");
            semCrane.Release();
        }

        public async Task Move(string from, string to, string newX)
        {
            ui.craneXpx = newX;
            await ui.InvokeAsync(ui.StateHasChanged);
            await Task.Delay(800);
        }
    }
}

<style>
.sim-area {
    position: relative;
    width: 400px;
    height: 180px;
    background: #f0f0f0;
    border-radius: 10px;
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    padding: 0 20px;
}

.sim-area img {
    width: 60px;
    transition: all 0.4s ease; /* faster for "jumping" effect */
}

.machineA.working, .machineB.working {
    filter: drop-shadow(0 0 10px lime);
    transform: scale(1.1);
}

.crane {
    position: absolute;
    top: 10px;
    width: 70px;
    transition: all 0.8s ease;
}
</style>
